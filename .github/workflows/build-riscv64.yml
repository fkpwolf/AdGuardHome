'name': 'Build linux/riscv64'

'env':
  'GO_VERSION': '1.25.7'
  'NODE_VERSION': '20'

'on':
  'workflow_dispatch':
  'push':
    'branches':
    - '**'

'jobs':
  'build':
    'runs-on': 'ubuntu-latest'
    'permissions':
      'contents': 'read'
    'steps':
    - 'name': 'Checkout'
      'uses': 'actions/checkout@v4'
      'with':
        'fetch-depth': 0

    - 'name': 'Set up Node'
      'uses': 'actions/setup-node@v4'
      'with':
        'node-version': '${{ env.NODE_VERSION }}'

    - 'name': 'Set up Go'
      'uses': 'actions/setup-go@v5'
      'with':
        'go-version': '${{ env.GO_VERSION }}'

    - 'name': 'Install frontend dependencies'
      'run': 'npm --prefix ./client ci'

    - 'name': 'Build frontend'
      'run': 'npm --prefix ./client run build-prod'

    - 'name': 'Download Go dependencies'
      'run': 'make go-deps'

    - 'name': 'Build AdGuardHome for linux/riscv64'
      'env':
        'GOOS': 'linux'
        'GOARCH': 'riscv64'
        'CGO_ENABLED': '0'
        # Set a custom version string to avoid the version script using
        # "master..HEAD", which fails when the master branch is not available
        # in the CI checkout environment.
        'VERSION': 'v0.0.0-github'
      'run': 'make go-build'

    - 'name': 'Package'
      'run': 'tar -czf AdGuardHome_linux_riscv64.tar.gz AdGuardHome'

    - 'name': 'Upload artifact'
      'uses': 'actions/upload-artifact@v4'
      'with':
        'name': 'AdGuardHome_linux_riscv64'
        'path': 'AdGuardHome_linux_riscv64.tar.gz'
